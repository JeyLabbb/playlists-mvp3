"# Módulo social PLEIA\n\n## Objetivo\nCrear una capa social que permita añadir amigos, ver su actividad musical y chatear de forma segura, reutilizando Supabase como backend.\n\n## Entregables\n- Tablas y RLS en Supabase.\n- Endpoints API (REST) y hooks cliente.\n- UI integrada en `/me`, `/trending`, `/u/[username]` y un nuevo hub social.\n- Notificaciones in-app básicas.\n\n## 1. Modelo de datos\n\n### Nuevas tablas (Supabase)\n| Tabla | Campos | Descripción |\n|-------|--------|-------------|\n| `friends` | `id`, `user_id`, `friend_id`, `created_at` | Registro de amistad confirmada. `user_id` y `friend_id` referencian `users.id`. |\n| `friend_requests` | `id`, `sender_id`, `receiver_id`, `status ('pending'|'accepted'|'declined')`, `created_at`, `responded_at` | Solicitudes bidireccionales. |\n| `friend_activity` | `id`, `user_id`, `type ('playlist_created'|'playlist_shared'|'status')`, `payload (jsonb)`, `created_at` | Feed amig@s. |\n| `social_messages` | `id`, `thread_id`, `sender_id`, `content`, `created_at`, `read_at` | Mensajes tipo chat. |\n| `social_threads` | `id`, `created_at` | Contenedores de conversación (1:1 inicialmente). |\n| `thread_participants` | `thread_id`, `user_id`, `joined_at`, `last_read_at` | Control de lectura. |\n\n### Columnas adicionales\n- `users.friends_count`, `users.last_social_activity_at` para métricas rápidas.\n- `playlists.visibility ('public'|'friends'|'private')` para controlar quién ve qué.\n\n## 2. RLS / Seguridad\n- Solo el dueño puede insertar en `friend_requests` como `sender_id`.\n- Lectura de `friends` limitada a filas donde el usuario participa.\n- `friend_activity` visible solo para amistades recíprocas.\n- Mensajes limitados a participantes del thread.\n\n## 3. API Layer (Next.js /app/api)\n### Endpoints\n- `POST /api/social/friends/request` → crear solicitud.\n- `POST /api/social/friends/respond` → aceptar/declinar.\n- `GET /api/social/friends` → listado actual.\n- `GET /api/social/activity` → feed paginado.\n- `POST /api/social/messages/send` → enviar mensaje.\n- `GET /api/social/messages/thread` → obtener historial.\n- `POST /api/social/share-playlist` → compartir playlist con amigos.\n\n## 4. Hooks & estado cliente\n- `useFriends()` (SWR) → amigos + solicitudes.\n- `useFriendActivity()` → feed con infinite scroll.\n- `useSocialChat(threadId)` → mensajes en tiempo real (SWR + polling 5s, luego suscripción Supabase).\n\n## 5. UI / UX\n- `Mi perfil`: pestañas \"Amigos\", \"Actividad\", \"Chat\".\n- Perfil público `/u/[username]`: botón \"Agregar\" / \"Cancelar\" / \"Aceptar\" según estado.\n- Trending/Home: tarjetas con icono \"Añadir\" al hover si no es amigo.\n- `My Playlists`: selector de visibilidad (público / amigos / privado).\n- Notificaciones (badge) en navigation cuando hay solicitudes nuevas.\n\n## 6. Iteración técnica\n1. Migraciones SQL y `supabase/policies` actualizadas.\n2. Endpoints + pruebas manuales (curl + Postman).\n3. Hooks cliente + SWR caches.\n4. UI inicial (sin chat) → release.\n5. Chat (threads, mensajes, realtime) → release.\n\n## 7. Pendientes\n- Supervisar coste de RLS y añadir índices (`friends (user_id)`, `friend_activity (user_id, created_at)`).\n- Reutilizar Paywall para gating de features premium (ej. feed extends?).\n- Telemetría (log event en `friend_activity` y `PageSpeed`).\n\n## 8. Riesgos\n- Necesidad de paginación server-side y rate limits.\n- Clientes móviles (si hay) deben adaptarse.\n- Privacidad: playlist `friends` requiere enforcement en `/api/trending` y `/api/userplaylists`.\n\n## 9. KPIs\n- Nº de amistades creadas/día.\n- Nº de interacciones (compartir playlist, mensajes).\n- Tiempo medio / visitas a feed social.\n"*** End Patch

